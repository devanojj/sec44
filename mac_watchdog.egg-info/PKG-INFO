Metadata-Version: 2.4
Name: mac-watchdog
Version: 0.1.0
Summary: Local-first macOS security watchdog
Author: Mac Watchdog
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: fastapi==0.115.8
Requires-Dist: uvicorn==0.34.0
Requires-Dist: jinja2==3.1.5
Requires-Dist: psutil==6.1.1
Requires-Dist: pydantic==2.10.6
Requires-Dist: watchdog==6.0.0
Provides-Extra: dev
Requires-Dist: pytest==8.3.4; extra == "dev"
Requires-Dist: httpx==0.28.1; extra == "dev"
Requires-Dist: ruff==0.9.6; extra == "dev"
Requires-Dist: black==24.10.0; extra == "dev"
Requires-Dist: mypy==1.15.0; extra == "dev"

# Mac Security Watchdog (Local-First MVP)

Security-focused macOS watchdog with deterministic, explainable security insights.

- Local-only operation by default (`127.0.0.1` bind, no outbound network calls).
- Rule-based insights engine (no opaque model dependency).
- FastAPI + Jinja2 + SQLite architecture with typed schemas and service boundaries.

## Core Insight Capabilities

1. Daily Brief
- Current risk score (0-100)
- Delta vs 7-day average
- Top risk driver
- Unusual behaviors (2-4)
- Priority action queue

2. Baseline-aware anomaly insights
- Signals:
  - `failed_logins_24h`
  - `new_listeners_24h`
  - `new_processes_24h`
  - `suspicious_exec_path_24h`
- Baseline = 14-day median
- Ratio = `today / max(1, baseline)`
- Classification:
  - `< 1.5`: normal
  - `1.5 to < 3`: elevated
  - `>= 3`: anomalous

3. Risk drivers
- Categories:
  - `network_exposure`
  - `process_anomaly`
  - `auth_anomaly`
  - `filewatch_anomaly`
- Contribution shown as % of today's weighted risk.

4. New vs resolved deltas (since yesterday)
- Diff-based fingerprint comparison between yesterday and today.

5. Explainable insight cards
- Severity (`INFO/WARN/HIGH`)
- Confidence (`LOW/MEDIUM/HIGH`)
- Exact rule text
- Structured evidence
- Recommended action
- Status (`open/resolved/acknowledged`)

6. Dedup/suppression
- Fingerprint-based collapse in rolling 30-minute window.
- Repeated events shown with `count` and `last_seen`.

7. Posture trend
- Today risk score vs 7-day average
- HIGH alerts/day 7-day series
- Status: Improving / Stable / Regressing

## Security Controls

- Local-only defaults
  - Loopback-only host validation in config.
  - Default bind: `127.0.0.1`.
- Web hardening
  - `/docs`, `/redoc`, and OpenAPI disabled by default.
  - Security headers middleware:
    - `Content-Security-Policy` (strict local template policy)
    - `X-Content-Type-Options: nosniff`
    - `X-Frame-Options: DENY`
    - `Referrer-Policy: no-referrer`
- Input/output safety
  - Strict Pydantic validation models across config/events/insights.
  - Sanitization and length-caps on persisted text fields.
  - Secret-like keys/values redacted during sanitization.
  - Jinja autoescape enforced; no untrusted HTML rendering.
- Command/process safety
  - No `shell=True`.
  - Fixed subprocess command/arguments only.
  - Timeouts and exception handling in collectors.
- DB safety
  - Parameterized SQL paths.
  - No user-driven dynamic SQL generation.
  - Data dir/file permissions: `0700` dir, `0600` config/db.
- Privacy defaults
  - No process command-line collection by default.
  - Redaction of password/token/secret-like content.
- Reliability
  - Collector and insight engine failures degrade into WARN events, not process crash.

## Insight Methodology

### Risk Scoring (deterministic)
- Weights: `INFO=1`, `WARN=3`, `HIGH=8` (configurable).
- `daily_weighted = INFO*1 + WARN*3 + HIGH*8`
- `rolling_max_30d = max(static_cap, today, historical_30d)`
- `risk_score = min(100, round(100 * daily_weighted / max(1, rolling_max_30d)))`
- Formula metadata is stored with daily metrics.

### Confidence Rules
- `HIGH`: deterministic strong signal context (for example anomalous listener/suspicious exec signals).
- `MEDIUM`: anomaly ratio `>= 3` with moderate evidence.
- `LOW`: anomaly ratio `1.5 <= ratio < 3` or weaker evidence.

## Data Model

Existing tables are preserved; these are added via migration:

- `daily_metrics`
  - `date TEXT PRIMARY KEY`
  - `risk_score INTEGER NOT NULL`
  - `high_count INTEGER NOT NULL`
  - `warn_count INTEGER NOT NULL`
  - `info_count INTEGER NOT NULL`
  - `failed_logins INTEGER NOT NULL`
  - `new_listeners INTEGER NOT NULL`
  - `new_processes INTEGER NOT NULL`
  - `suspicious_execs INTEGER NOT NULL`
  - `baseline_deltas_json TEXT NOT NULL`
  - `drivers_json TEXT NOT NULL`
  - `updated_at TEXT NOT NULL`

- `insights`
  - `id INTEGER PRIMARY KEY`
  - `ts TEXT NOT NULL`
  - `insight_type TEXT NOT NULL`
  - `source TEXT NOT NULL`
  - `severity TEXT NOT NULL`
  - `confidence TEXT NOT NULL`
  - `title TEXT NOT NULL`
  - `explanation TEXT NOT NULL`
  - `evidence_json TEXT NOT NULL`
  - `action_text TEXT NOT NULL`
  - `fingerprint TEXT NOT NULL`
  - `status TEXT NOT NULL DEFAULT 'open'`
  - `first_seen TEXT NOT NULL`
  - `last_seen TEXT NOT NULL`
  - `count INTEGER NOT NULL DEFAULT 1`

Indexes:
- `idx_insights_ts`
- `idx_insights_status`
- `idx_insights_severity`
- `idx_insights_fingerprint`
- `idx_daily_metrics_date`

Migration files:
- `mac_watchdog/migrations/0001_daily_metrics_insights.sql`

## Routes

- `/overview` (also `/`): Daily Brief + action queue + drivers + deltas + anomalies + trend
- `/insights`: paginated insight cards with filters (`severity`, `source`, `status`, `start`, `end`)
- `/events`: raw evidence timeline
- `/listeners`
- `/settings`

## Commands

Initialize config and DB:

```bash
mac-watchdog init
```

Apply migrations + backfill metrics/insights where possible:

```bash
mac-watchdog migrate
```

Run collector daemon (with insights generation each cycle):

```bash
mac-watchdog daemon --verbose
```

Run UI only:

```bash
mac-watchdog serve --host 127.0.0.1 --port 8765
```

Run one cycle:

```bash
mac-watchdog run-once --verbose
```

Run tests:

```bash
pytest
```

## Seed Demo Data

Use deterministic seeded telemetry to validate insight quality quickly:

```bash
python seed_demo_data.py
```

Optional:

```bash
python seed_demo_data.py --days 21
python seed_demo_data.py --no-reset
```

## Compatibility and Backfill

- Migration is versioned via `schema_migrations`.
- Backfill is best-effort:
  - Reconstructs `daily_metrics` and `insights` from existing events where possible.
  - If historical reconstruction is incomplete, forward computation still works from current day.

## Limitations

- Local SQLite is not tamper-evident.
- Host-level collection fidelity can be constrained by macOS permissions.
- No multi-user auth model because MVP is loopback-local only.
- Rule-based scoring is deterministic but intentionally conservative.

## Future SaaS Migration Plan

1. Keep current local collectors as agent modules with signed artifacts.
2. Replace local persistence with buffered signed event transport + mTLS ingest.
3. Add tenant-aware authn/authz and policy distribution.
4. Move insight services to shared stateless compute workers.
5. Add centralized audit logs, retention controls, and policy attestation.
